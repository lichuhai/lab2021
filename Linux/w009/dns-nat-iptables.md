# Linux Administrator

# DNS

## DNS服务器原理简述

DNS：Domain Name Service，通过将域名转换为IP，实现便于记忆的效果

DNS查询方式

1. 递归查询：DNS代替来访DNS去向其他DNS服务器查询
2. 迭代查询：DNS服务器上没有记录的时候，返回可能有记录的DNS服务器给来访的DNS服务器，让其自己去查询

域名解析流程（查询到则不再往下）

1. 程序发起域名解析要求
2. 查询cache
3. 查询OS的hosts文件
4. 查询本地的DNS服务器
5. 查询互联网的DNS服务器



## 搭建DNS服务器

### DNS服务器搭建和配置

配置主机名和静态ip

```sh
[root@dns ~]# hostname
dns.hai
[root@dns ~]# hostname -I
192.168.20.11

```

安装bind软件

```sh
[root@dns ~]# yum -y install bind
```

配置文件指定zone

```sh
[root@dns ~]# cp /etc/named.conf{,.bak}
[root@dns ~]# vi /etc/named.conf
//# 注释掉
        // listen-on port 53 { 127.0.0.1; };
        // listen-on-v6 port 53 { ::1; };
        //allow-query     { localhost; };


# 添加
[root@vm1 ~]# tail -4 /etc/named.rfc1912.zones
zone "dns.hai" IN {
        type master;
        file "dns.hai.zone";
};


```

验证配置文件

```sh
[root@dns ~]# named-checkconf
[root@dns ~]# echo $?
0

```

zone数据库文件创建

```sh
[root@dns ~]# cp -p /var/named/named.localhost /var/named/dns.hai.zone

[root@dns ~]# ll /var/named/dns.hai.zone
-rw-r----- 1 root named 183 Feb 27 23:13 /var/named/dns.hai.zone
[root@dns ~]# ll /var/named/named.localhost
-rw-r----- 1 root named 152 Oct 11 18:41 /var/named/named.localhost

[root@dns ~]# cat /var/named/dns.hai.zone
$TTL 1D
@       IN SOA  master dns.hai. (
                                        20220404        ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      master
master  A       192.168.20.11
www     A       192.168.20.11

```

验证zone文件

```sh
[root@dns ~]# named-checkzone dns.hai /var/named/dns.hai.zone
zone dns.hai/IN: loaded serial 20220404
OK

```

启动DNS服务

```sh

[root@dns ~]# systemctl restart named
[root@dns ~]# systemctl status named
● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled; vendor preset: disabled)
   Active: active (running) since Sun 2022-02-27 23:20:38 CST; 4s ago
  Process: 2246 ExecStart=/usr/sbin/named -u named -c ${NAMEDCONF} $OPTIONS (code=exited, status=0/SUCCESS)
  Process: 2244 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING" == "yes" ]; then /usr/sbin/named-checkconf -z "$NAMEDCONF"; else echo "Checking of zone files is disable>
 Main PID: 2248 (named)
    Tasks: 4 (limit: 2581)
   Memory: 55.9M
   CGroup: /system.slice/named.service
           └─2248 /usr/sbin/named -u named -c /etc/named.conf

Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './DNSKEY/IN': 199.9.14.201#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './NS/IN': 199.9.14.201#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './DNSKEY/IN': 199.7.91.13#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './NS/IN': 199.7.91.13#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './DNSKEY/IN': 192.36.148.17#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './NS/IN': 192.36.148.17#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './NS/IN': 198.41.0.4#53
Feb 27 23:20:38 dns.hai named[2248]: SERVFAIL unexpected RCODE resolving './DNSKEY/IN': 198.41.0.4#53
Feb 27 23:20:38 dns.hai named[2248]: resolver priming query complete
Feb 27 23:20:38 dns.hai named[2248]: managed-keys-zone: Unable to fetch DNSKEY set '.': failure

```

监听端口

```sh
[root@dns ~]# ss -ntlp | grep named
LISTEN 0      10     192.168.20.11:53        0.0.0.0:*    users:(("named",pid=2248,fd=23))
LISTEN 0      10         127.0.0.1:53        0.0.0.0:*    users:(("named",pid=2248,fd=22))
LISTEN 0      128        127.0.0.1:953       0.0.0.0:*    users:(("named",pid=2248,fd=24))
LISTEN 0      10              [::]:53           [::]:*    users:(("named",pid=2248,fd=21))
LISTEN 0      128            [::1]:953          [::]:*    users:(("named",pid=2248,fd=25))

```

搭建网页服务器（测试用，非必要）

```sh
# 安装nginx略
# 配置主页
[root@dns ~]# echo 'web in dns' > /usr/local/nginx/html/index.html

[root@dns ~]# curl localhost
web in dns

```

### 客户端设置DNS并测试

配置dns和ip

```sh
[root@vm1 ~]# nmcli con add type ethernet ifname ens160 con-name ens160-local-dns autoconnect yes save yes ipv4.method manual ipv4.addr "192.168.20.11/24" ipv4.dns "192.168.20.11"
Connection 'ens160-local-dns' (898106c2-05a4-4c7c-bff0-b80732af7f97) successfully added.
[root@vm1 ~]# nmcli con up ens160-local-dns
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/3)
[root@vm1 ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search hai
nameserver 192.168.20.11
```

测试

```sh
[root@vm1 ~]# ping -c1 www.dns.hai
PING www.dns.hai (192.168.20.11) 56(84) bytes of data.
64 bytes from dns.hai (192.168.20.11): icmp_seq=1 ttl=64 time=0.013 ms

--- www.dns.hai ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.013/0.013/0.013/0.000 ms
[root@vm1 ~]# dig www.dns.hai

; <<>> DiG 9.11.26-RedHat-9.11.26-6.el8 <<>> www.dns.hai
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 43538
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 34fdfed740fbb695ce8b7cbc621b9ea75591a9993270eb1f (good)
;; QUESTION SECTION:
;www.dns.hai.                   IN      A

;; ANSWER SECTION:
www.dns.hai.            86400   IN      A       192.168.20.11

;; AUTHORITY SECTION:
dns.hai.                86400   IN      NS      master.dns.hai.

;; ADDITIONAL SECTION:
master.dns.hai.         86400   IN      A       192.168.20.11

;; Query time: 0 msec
;; SERVER: 192.168.20.11#53(192.168.20.11)
;; WHEN: Sun Feb 27 23:54:15 CST 2022
;; MSG SIZE  rcvd: 121

[root@vm1 ~]# curl www.dns.hai
web in dns

```

该DNS没有设置查询，无法解析其他的zone

```sh
[root@vm1 ~]# ping baidu.com -c1
ping: baidu.com: Name or service not known

```



## 追加DNS从服务器

### 从服务器配置

主机名和ip

```sh
[root@dns2 ~]# hostname
dns2.dns.hai
[root@dns2 ~]# ip -br a show ens160
ens160           UP             192.168.20.21/24 fe80::2b2b:1792:513d:ed93/64

```

安装bind

```sh
[root@dns2 ~]# dnf -y install bind

```

配置从服务器的zone

```sh
[root@dns2 ~]# vi /etc/named.conf
//# 注释掉
        //listen-on port 53 { 127.0.0.1; };
        //listen-on-v6 port 53 { ::1; };
        //allow-query     { localhost; };
//#添加
        allow-transfer { none; };

# 追加
[root@dns2 ~]# tail -5 /etc/named.rfc1912.zones
zone "dns.hai" IN {
        type slave;
        masters { 192.168.20.11; };
        file "slaves/dns.hai.zone";
};

```

验证配置文件

```sh
[root@dns2 ~]# named-checkconf
[root@dns2 ~]# echo $?
0

```

重启named服务

```sh
[root@dns2 ~]# systemctl restart named

```

验证zone文件（稍后主服务器配置许可后）

```sh
[root@dns2 ~]# dnf -y install bind-utils

```



### 主服务器配置

允许从服务器传送

```sh
[root@dns ~]# vi /etc/named.conf
//#注释掉
        // allow-query     { localhost; };
        //allow-query     { localhost; };

//# 追加许可zone传送
        allow-transfer { 192.168.20.21; };

```

其他配置保留不变

验证配置

```sh
[root@dns ~]# named-checkconf
[root@dns ~]# echo $?
0

```

追加从服务器的DNS记录（dns2）

```sh

[root@dns ~]# cat /var/named/dns.hai.zone
$TTL 1D
@       IN SOA  master dns.hai. (
                                        20220404        ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS      master
master  A       192.168.20.11
www     A       192.168.20.11
dns2    A       192.168.20.12

```

重启服务

```sh
[root@dns ~]# systemctl restart named

```

在从服务器上查看

```sh
[root@dns2 ~]# ls /var/named/slaves/
dns.hai.zone

```

在从服务器上不能验证这个传送过来的zone文件

```sh
[root@dns2 ~]# named-checkzone dns.hai /var/named/slaves/dns.hai.zone
dns_master_load: /var/named/slaves/dns.hai.zone:1: syntax error
dns_master_load: /var/named/slaves/dns.hai.zone:1: syntax error

# 乱码了
[root@dns2 ~]# cat /var/named/slaves/dns.hai.zone
bOLQ▒   dnshai-masterdnshaidnshai4▒▒Q▒  :▒*0/Q▒ dnshaimasterdnshai(Q▒dns2dnshai▒*Q▒masterdnshai▒
wwwdnshai▒                                                                                      'Q▒
          [root@dns2 ~]#

```

### 客户端测试DNS主从

#### 直接指定DNS从服务器

```sh
[root@vm1 ~]# nslookup www.dns.hai dns2.dns.hai
Server:         dns2.dns.hai
Address:        192.168.20.21#53

Name:   www.dns.hai
Address: 192.168.20.11

```

#### 配置多个DNS

配置

```sh
[root@vm1 ~]# nmcli con add type ethernet ifname ens160 con-name ens160-local-dns2 autoconnect yes save yes ipv4.method manual ipv4.addr "192.168.20.11/24" ipv4.dns "192.168.20.11, 192.168.20.21"
Connection 'ens160-local-dns2' (a6dcffff-b3af-4916-8de8-b5c8b0c07c5f) successfully added.
[root@vm1 ~]# nmcli con up ens160-local-dns2
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)
[root@vm1 ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search hai
nameserver 192.168.20.11
nameserver 192.168.20.21

```

当主DNS宕机

```sh

[root@dns ~]# systemctl stop named
[root@dns ~]# systemctl status named
● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; disabled; vendor preset: disabled)
   Active: inactive (dead)

Feb 28 00:13:59 dns.hai named[2532]: received control channel command 'stop'
Feb 28 00:13:59 dns.hai named[2532]: shutting down: flushing changes
Feb 28 00:13:59 dns.hai named[2532]: stopping command channel on 127.0.0.1#953
Feb 28 00:13:59 dns.hai named[2532]: stopping command channel on ::1#953
Feb 28 00:13:59 dns.hai named[2532]: no longer listening on ::#53
Feb 28 00:13:59 dns.hai named[2532]: no longer listening on 127.0.0.1#53
Feb 28 00:13:59 dns.hai named[2532]: no longer listening on 192.168.20.11#53
Feb 28 00:14:00 dns.hai named[2532]: exiting
Feb 28 00:14:00 dns.hai systemd[1]: named.service: Succeeded.
Feb 28 00:14:00 dns.hai systemd[1]: Stopped Berkeley Internet Name Domain (DNS).

```

此时访问

```sh
# 无需指定，自动寻找2号机
[root@vm1 ~]# nslookup www.dns.hai
Server:         192.168.20.21
Address:        192.168.20.21#53

Name:   www.dns.hai
Address: 192.168.20.11

[root@vm1 ~]# curl www.dns.hai
web in dns

```



# 搭建并实现智能DNS

# 使用iptable实现: 放行ssh,telnet, ftp, web服务80端口，其他端口服务全部拒绝

设置，假设其他的设置都不要

```sh
[root@vm1 ~]# iptables -F

[root@vm1 ~]# iptables -A INPUT -p tcp -m multiport --dport 21,22,23,80 -j ACCEPT

[root@vm1 ~]# iptables -A INPUT -p tcp -j DROP

[root@dns ~]# iptables -vnL INPUT
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    8   544 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport dports 21,22,23,80
    0     0 DROP       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0

```

测试，不通。。。

```sh

[root@dns ~]# curl 192.168.20.11
^C
[root@dns ~]#

```



# NAT原理总结





# iptables实现SNAT和DNAT，并对规则持久保存
